<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jotform Custom Widget - Name and Signature Table</title>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"] {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        canvas {
            border: 1px solid #ccc;
            width: 100%;
            height: 60px;
            cursor: crosshair;
        }
    </style>
</head>
<body>
    <table id="signatureTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Signature</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" class="name-input" maxlength="100"></td>
                <td>
                    <canvas class="signature-canvas"></canvas>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        (function () {
            // Initialize signature canvases
            const canvases = document.querySelectorAll('.signature-canvas');
            const clearButtons = document.querySelectorAll('.clear-btn');
            const nameInputs = document.querySelectorAll('.name-input');
            const signatures = Array.from(canvases).map(() => ({
                ctx: null,
                isDrawing: false,
                lastX: 0,
                lastY: 0,
                isEmpty: true
            }));

            canvases.forEach((canvas, index) => {
                canvas.width = canvas.offsetWidth;
                canvas.height = 60;
                signatures[index].ctx = canvas.getContext('2d');
                signatures[index].ctx.lineWidth = 2;
                signatures[index].ctx.lineCap = 'round';
                signatures[index].ctx.lineJoin = 'round';

                // Drawing event listeners
                canvas.addEventListener('mousedown', (e) => startDrawing(e, index));
                canvas.addEventListener('mousemove', (e) => draw(e, index));
                canvas.addEventListener('mouseup', () => stopDrawing(index));
                canvas.addEventListener('mouseout', () => stopDrawing(index));

                // Touch support
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    startDrawing(e.touches[0], index);
                });
                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    draw(e.touches[0], index);
                });
                canvas.addEventListener('touchend', () => stopDrawing(index));
            });

            function startDrawing(e, index) {
                const rect = canvases[index].getBoundingClientRect();
                signatures[index].isDrawing = true;
                signatures[index].lastX = e.clientX - rect.left;
                signatures[index].lastY = e.clientY - rect.top;
                signatures[index].isEmpty = false;
            }

            function draw(e, index) {
                if (!signatures[index].isDrawing) return;

                const rect = canvases[index].getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                signatures[index].ctx.beginPath();
                signatures[index].ctx.moveTo(signatures[index].lastX, signatures[index].lastY);
                signatures[index].ctx.lineTo(x, y);
                signatures[index].ctx.stroke();

                signatures[index].lastX = x;
                signatures[index].lastY = y;

                sendData();
            }

            function stopDrawing(index) {
                signatures[index].isDrawing = false;
            }

            function sendData() {
                const data = Array.from(nameInputs).map((input, index) => ({
                    name: input.value.trim(),
                    signature: signatures[index].isEmpty ? '' : canvases[index].toDataURL('image/png')
                }));

                // Allow empty rows, so always mark as valid
                //JFCustomWidget.sendData({
                //    value: JSON.stringify(data),
                //    widgetHeight: document.body.scrollHeight
                //});

                JFCustomWidget.sendSubmit({
                    valid: true, // Always valid to allow empty rows and avoid required error
                    value: JSON.stringify(data)
                });
            }

            // Send initial data
            JFCustomWidget.subscribe('ready', () => {
                sendData();

                // Update on name input
                //nameInputs.forEach(input => {
                //    input.addEventListener('input', sendData);
                //});
            });

            // Send data to Jotform when submitted
            //JFCustomWidget.subscribe("submit", function() {
            //    const selectedId = dropdown.value;
            //    const nameValue = nameField.value;
            //    JFCustomWidget.sendSubmit({
            //        valid: true,
            //        value: JSON.stringify({ submissionId: selectedId, name: nameValue })
            //    });
            // });

            // Handle widget resizing
            function resizeCanvases() {
                canvases.forEach((canvas, index) => {
                    if (signatures[index].isEmpty) return;
                    const dataURL = canvases[index].toDataURL('image/png');
                    canvas.width = canvas.offsetWidth;
                    const img = new Image();
                    img.src = dataURL;
                    img.onload = () => {
                        signatures[index].ctx.drawImage(img, 0, 0);
                    };
                });
            }

            window.addEventListener('resize', resizeCanvases);
        })();
    </script>
</body>
</html>